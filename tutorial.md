# Code_Saturne LUMA Coupling Tutorial

This tutorial will guide you through setting up a 2D lid-driven cavity simulation run using Code_Saturne coupled to LUMA in a unit cube domain.  LUMA will evolve the portion x <= 0.55, and Code_Saturne will evolve the portion x <= 0.45.  The boundary x=0 is driven with a velocity $v_y = 1$.  Boundary data at the coupling boundaries is obtained from the other code using the PLE library.

## Set up the case

Versions of Code_Saturne and LUMA which include support for coupling
between them, as well as the example lid-driven cavity case
definition, are installed on ARCHER2.

Set up your environment to give access to the software:
```bash
module purge

module load PrgEnv-gnu
module load cray-python/3.8.5.0

source /work/ecseaa28/shared/software/cs-luma-1.0.0-alpha.1-3-g592816a/setup.sh
```

Note that while the installed version of Code_Saturne can be used directly, LUMA must be compiled for each case you want to run, as the case parameters are configured through its definitions.h header file.

The case definition, `$CS_LUMA_DIR/cases/ldc_left_right`, looks like this:

```
ldc_left_right
├── LEFT
│   └── definitions.h
├── RIGHT
│   ├── DATA
│   │   └── setup.xml
│   ├── SRC
│   │   └── cs_user_coupling.c
└── run.cfg
```

The files are:

| File                 | Purpose                                                                        |
|----------------------|--------------------------------------------------------------------------------|
| `LEFT` and `RIGHT`   | The names of the two domains (evolved by LUMA and Code\_Saturne, respectively) |
| `definitions.h`      | LUMA case definition                                                           |
| `setup.xml`          | Code\_Saturne case definition                                                  |
| `cs_user_coupling.c` | Additional Code\_Saturne configuration related to coupling                      |
| `run.cfg`            | Includes specification of the mapping between domains and codes                |


On ARCHER2, the case must be set up in the "work" filesystem, as the home directory is not available on the compute nodes.

Change into the directory in which you want to set up the case, and copy the example case definition into this directory:
```
cp -a $CS_LUMA_DIR/cases/ldc_left_right .
```

At this point, you could customise the case by editing the configuration files, but for this tutorial, we will run the case as-is.

## Compile LUMA for this case

Next, compile a LUMA executable `LEFT/LUMA` using `LEFT/definitions.h`:

```
cd ldc_left_right
build-luma LEFT/definitions.h LEFT/LUMA CS_INSTALL=$CODE_SATURNE_DIR
```

## Submit the case

Write a batch script to run the case:

```
#!/bin/bash

#SBATCH --job-name       ldc_left_right
#SBATCH --output         log.txt
#SBATCH --ntasks         256
#SBATCH --nodes          2
#SBATCH --cpus-per-task  1
#SBATCH --account        ecseaa28 # Change to your own account
#SBATCH --partition      standard
#SBATCH --time           12:00:00
#SBATCH --qos            lowpriority

set -eu

module purge

module load PrgEnv-gnu
module load cray-python/3.8.5.0

source /work/ecseaa28/shared/software/cs-luma-1.0.0-alpha.1-3-g592816a/setup.sh

code_saturne run
```

and save it in the case directory as `submit.sh`.  The simulation will run with 128 LUMA processes on one node, and 128 Code\_Saturne processes on another node.

Submit the batch job:

```
sbatch submit.sh
```

When the job runs, log.txt will contain some logging information, but the detailed logs from the two codes will be in

```
RESU_COUPLING/*/LEFT/output_*/log_rank0.log
```

and

```
RESU_COUPLING/*/RIGHT/run_solver.log
```

The \* wildcards above are needed because those components of the paths are generated timestamps generated by Code\_Saturne and LUMA to ensure that the output from repeated runs goes to different directories.  The simulation should take about 25 minutes to complete.

## Visualise with ParaView

**THIS SECTION IS INCOMPLETE**

The 3D LUMA field data will be in

```
RESU_COUPLING/*/LEFT/output_*/hdf_R0N0.h5
```

In order to visualise this in ParaView, it can be converted to VTK format:

```
cd RESU_COUPLING/*/LEFT/output_*
$luma_dir/tools/postprocessing/h5mgm/h5mgm
cd ../../../..
```

The VTK files will be generated in `RESU_COUPLING/*/LEFT/output_*/postprocessedoutput`.

The output of the simulation can be visualised in ParaView.  You can either run ParaView in client-server mode, with pvserver running on Archer, and a local ParaView client running on your own computer, or you can copy the case output data to your own computer and visualise them directly with ParaView running there.  Documentation for using ParaView in client-server mode is available [here](https://docs.archer2.ac.uk/data-tools/paraview/).

Launch ParaView and open the LUMA Fluid timeseries from `RESU_COUPLING/*/LEFT/output_*/postprocessedoutput`.

Next, open the Code\_Saturne fluid data from `RESU_COUPLING/*/RIGHT/postprocessing/RESULTS_FLUID_DOMAIN.case`.

Make a plot of the  $y$ component of velocity from each dataset.

The LUMA data will need to be rescaled by a factor of 0.005/0.001 to convert from Lattice Boltzmann units to physical units.

The LUMA data will need timestep information added, to ensure it is in sync with the Code\_Saturne data.


